<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Arthur Game Shop</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="admin.css">
</head>
<body>
    <!-- Admin Header -->
    <nav class="admin-navbar">
        <div class="container-fluid">
            <div class="navbar-brand">
                <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">
                    <i class="bi bi-list"></i>
                </button>
                <i class="bi bi-shield-check"></i>
                <span>Admin Panel</span>
            </div>
            <div class="navbar-actions">
                <button class="btn btn-outline-light" onclick="logout()">
                    <i class="bi bi-box-arrow-right"></i> <span class="d-none d-md-inline">Logout</span>
                </button>
            </div>
        </div>
    </nav>

    <!-- Mobile Menu Overlay -->
    <div class="mobile-menu-overlay" onclick="closeMobileMenu()"></div>

    <div class="admin-container">
        <!-- Sidebar -->
        <div class="admin-sidebar" id="adminSidebar">
            <div class="sidebar-header">
                <h5><i class="bi bi-person-circle"></i> Admin Dashboard</h5>
                <button class="mobile-close-btn" onclick="closeMobileMenu()">
                    <i class="bi bi-x"></i>
                </button>
            </div>
            <ul class="sidebar-menu">
                <li class="menu-item active" data-page="dashboard">
                    <i class="bi bi-speedometer2"></i>
                    <span>Dashboard</span>
                </li>
                <li class="menu-item" data-page="users">
                    <i class="bi bi-people"></i>
                    <span>Users</span>
                </li>
                <li class="menu-item" data-page="orders">
                    <i class="bi bi-bag"></i>
                    <span>Orders</span>
                </li>
                <li class="menu-item" data-page="transactions">
                    <i class="bi bi-credit-card"></i>
                    <span>Transactions</span>
                </li>
                <li class="menu-item" data-page="wallets">
                    <i class="bi bi-wallet2"></i>
                    <span>Wallets</span>
                </li>
            </ul>
        </div>

        <!-- Main Content -->
        <div class="admin-main">
            <!-- Dashboard Page -->
            <div id="dashboard-page" class="page-content active">
                <div class="page-header">
                    <h2><i class="bi bi-speedometer2"></i> Dashboard Overview</h2>
                    <p>Welcome to Arthur Game Shop Admin Panel</p>
                </div>

                <!-- Stats Cards -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="bi bi-people"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="total-users">0</h3>
                            <p>Total Users</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="bi bi-bag"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="total-orders">0</h3>
                            <p>Total Orders</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="bi bi-credit-card"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="total-revenue">0.00</h3>
                            <p>Total Revenue (Ks)</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="bi bi-clock-history"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="pending-orders">0</h3>
                            <p>Pending Orders</p>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="recent-activity">
                    <h4><i class="bi bi-clock-history"></i> Recent Activity</h4>
                    <div id="recent-activity-list">
                        <div class="activity-item">
                            <div class="loading"></div>
                            <span>Loading recent activity...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Users Page -->
            <div id="users-page" class="page-content">
                <div class="page-header">
                    <h2><i class="bi bi-people"></i> User Management</h2>
                    <div class="header-actions">
                        <button class="btn btn-outline-primary" onclick="exportUsers()">
                            <i class="bi bi-download"></i> Export
                        </button>
                        <button class="btn btn-primary" onclick="loadUsers()">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </button>
                    </div>
                </div>
                
                <!-- User Search and Filters -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="input-group">
                            <input type="text" class="form-control" id="user-search" placeholder="Search users..." onkeyup="filterUsers()">
                            <button class="btn btn-outline-secondary" type="button">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="user-sort">
                            <option value="newest">Newest First</option>
                            <option value="oldest">Oldest First</option>
                            <option value="balance-high">Balance: High to Low</option>
                            <option value="balance-low">Balance: Low to High</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="user-filter">
                            <option value="all">All Users</option>
                            <option value="with-balance">With Balance</option>
                            <option value="no-balance">No Balance</option>
                        </select>
                    </div>
                </div>

                <div class="table-container">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Balance (Ks)</th>
                                    <th>Tokens</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="users-table">
                                <tr>
                                    <td colspan="7" class="text-center">
                                        <div class="loading"></div>
                                        Loading users...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Pagination -->
                <nav aria-label="User pagination">
                    <ul class="pagination justify-content-center" id="users-pagination">
                        <li class="page-item disabled">
                            <a class="page-link" href="#">Previous</a>
                        </li>
                        <li class="page-item active">
                            <a class="page-link" href="#">1</a>
                        </li>
                        <li class="page-item disabled">
                            <a class="page-link" href="#">Next</a>
                        </li>
                    </ul>
                </nav>
            </div>

            <!-- Orders Page -->
            <div id="orders-page" class="page-content">
                <div class="page-header">
                    <h2><i class="bi bi-bag"></i> Order Management</h2>
                    <div class="header-actions">
                        <button class="btn btn-outline-primary" onclick="exportOrders()">
                            <i class="bi bi-download"></i> Export
                        </button>
                        <button class="btn btn-primary" onclick="loadOrders()">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </button>
                    </div>
                </div>

                <div class="table-container">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Order ID</th>
                                    <th>User</th>
                                    <th>Product</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="orders-table">
                                <tr>
                                    <td colspan="7" class="text-center">
                                        <div class="loading"></div>
                                        Loading orders...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Transactions Page -->
            <div id="transactions-page" class="page-content">
                <div class="page-header">
                    <h2><i class="bi bi-credit-card"></i> Transaction Management</h2>
                    <div class="header-actions">
                        <select class="form-select" id="transaction-type-filter">
                            <option value="">All Types</option>
                            <option value="deposit">Deposit</option>
                            <option value="withdraw">Withdraw</option>
                            <option value="order">Order Payment</option>
                            <option value="gift">Gift Prize</option>
                        </select>
                        <button class="btn btn-primary" onclick="loadTransactions()">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </button>
                    </div>
                </div>

                <div class="table-container">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Transaction ID</th>
                                    <th>User</th>
                                    <th>Type</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="transactions-table">
                                <tr>
                                    <td colspan="7" class="text-center">
                                        <div class="loading"></div>
                                        Loading transactions...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Wallet Management Page -->
            <div id="wallets-page" class="page-content">
                <div class="page-header">
                    <h2><i class="bi bi-wallet2"></i> Wallet Management</h2>
                    <div class="header-actions">
                        <button class="btn btn-outline-success" onclick="showBulkAddFunds()">
                            <i class="bi bi-plus-circle"></i> Bulk Add Funds
                        </button>
                        <button class="btn btn-outline-info" onclick="showBulkAddTokens()">
                            <i class="bi bi-plus-circle"></i> Bulk Add Tokens
                        </button>
                        <button class="btn btn-primary" onclick="loadWallets()">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </button>
                    </div>
                </div>

                <div class="table-container">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Total (Ks)</th>
                                    <th>Available (Ks)</th>
                                    <th>On Hold (Ks)</th>
                                    <th>Tokens</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="wallets-table">
                                <tr>
                                    <td colspan="6" class="text-center">
                                        <div class="loading"></div>
                                        Loading wallets...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay" style="display: none;">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <p>Loading...</p>
        </div>
    </div>

    <!-- Error Modal -->
    <div id="error-modal" class="modal fade" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Error</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="error-message">An error occurred</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="retryOperation()">Retry</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Modal -->
    <div id="actionModal" class="modal fade" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Action</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="modalBody">
                    <!-- Dynamic content will be inserted here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="modalConfirm">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="admin.js"></script>
    
    <script>
        // Global variables (adminData is defined in admin.js)
        let currentOperation = null;
        let adminPanelLoaded = false;
        let inactivityTimer = null;
        
        // Check authentication on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Admin panel loading...');
            
            // Check if admin token exists
            const adminToken = localStorage.getItem('adminToken');
            if (!adminToken) {
                console.log('No admin token found, redirecting to login');
                window.location.href = 'login.html';
                return;
            }
            
            // Verify token with server
            verifyAdminToken(adminToken);
        });
        
        // Verify admin token
        async function verifyAdminToken(token) {
            try {
                console.log('Verifying admin token...');
                const response = await fetch('https://arthur-game-shop.onrender.com/api/admin/verify', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('Verification response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Verification response data:', data);
                    console.log('Token is valid:', data.valid);
                    
                if (data.valid) {
                    console.log('Token is valid, initializing admin panel');
                    initializeAdminPanel();
                } else {
                    console.log('Invalid token, redirecting to login');
                    localStorage.removeItem('adminToken');
                    window.location.href = 'login.html';
                }
            } else {
                console.log('Token verification failed, redirecting to login');
                localStorage.removeItem('adminToken');
                window.location.href = 'login.html';
            }
        } catch (error) {
            console.log('Token verification error:', error);
            // Only allow fallback mode if it's a network error, not auth error
            if (error.message.includes('fetch') || error.message.includes('network')) {
                console.log('Network error, using fallback mode');
                initializeAdminPanel();
            } else {
                console.log('Authentication error, redirecting to login');
                localStorage.removeItem('adminToken');
                window.location.href = 'login.html';
            }
        }
        }
        
        // Initialize admin panel
        function initializeAdminPanel() {
            console.log('Initializing admin panel...');
            
            // Setup event listeners
            setupEventListeners();
            setupMobileMenu();
            
            // Load dashboard data
            loadDashboard();
            
            // Mark as loaded
            adminPanelLoaded = true;
            
            console.log('Admin panel initialized successfully');
        }
        
        // Setup event listeners
        function setupEventListeners() {
            // Menu item clicks
            document.querySelectorAll('.menu-item').forEach(item => {
                item.addEventListener('click', function() {
                    const page = this.getAttribute('data-page');
                    console.log('Menu item clicked:', page);
                    switchPage(page);
                });
            });
            
            // Search input
            const userSearch = document.getElementById('user-search');
            if (userSearch) {
                userSearch.addEventListener('input', filterUsers);
            }
            
            // Sort and filter dropdowns
            const userSort = document.getElementById('user-sort');
            const userFilter = document.getElementById('user-filter');
            if (userSort) userSort.addEventListener('change', filterUsers);
            if (userFilter) userFilter.addEventListener('change', filterUsers);
            
            // Transaction type filter
            const transactionFilter = document.getElementById('transaction-type-filter');
            if (transactionFilter) {
                transactionFilter.addEventListener('change', filterTransactions);
            }
        }
        
        // Setup mobile menu
        function setupMobileMenu() {
            console.log('Setting up mobile menu...');
            
            // Mobile menu toggle
            window.toggleMobileMenu = function() {
                const sidebar = document.getElementById('adminSidebar');
                const overlay = document.querySelector('.mobile-menu-overlay');
                
                if (sidebar && overlay) {
                    sidebar.classList.toggle('active');
                    overlay.classList.toggle('active');
                }
            };
            
            // Close mobile menu
            window.closeMobileMenu = function() {
                const sidebar = document.getElementById('adminSidebar');
                const overlay = document.querySelector('.mobile-menu-overlay');
                
                if (sidebar && overlay) {
                    sidebar.classList.remove('active');
                    overlay.classList.remove('active');
                }
            };
            
            // Handle window resize
            window.addEventListener('resize', function() {
                if (window.innerWidth > 768) {
                    closeMobileMenu();
                }
            });
            
            console.log('Mobile menu setup complete');
        }
        
        // Switch page
        function switchPage(page) {
            console.log('Switching to page:', page);
            
            // Remove active class from all menu items
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Add active class to clicked menu item
            const activeMenuItem = document.querySelector(`[data-page="${page}"]`);
            if (activeMenuItem) {
                activeMenuItem.classList.add('active');
            }
            
            // Hide all page content
            document.querySelectorAll('.page-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Show selected page
            const pageContent = document.getElementById(`${page}-page`);
            if (pageContent) {
                pageContent.classList.add('active');
            }
            
            // Load page data
            switch(page) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'users':
                    loadUsers();
                    break;
                case 'orders':
                    loadOrders();
                    break;
                case 'transactions':
                    loadTransactions();
                    break;
                case 'wallets':
                    loadWallets();
                    break;
            }
        }
        
        // Show loading overlay
        function showLoading() {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) {
                overlay.style.display = 'flex';
            }
        }
        
        // Hide loading overlay
        function hideLoading() {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
        }
        
        // Show error modal
        function showError(message) {
            const errorMessage = document.getElementById('error-message');
            if (errorMessage) {
                errorMessage.textContent = message;
            }
            
            const errorModal = new bootstrap.Modal(document.getElementById('error-modal'));
            errorModal.show();
        }
        
        // Retry operation
        function retryOperation() {
            if (currentOperation) {
                currentOperation();
            }
        }
        
        // Logout function
        function logout() {
            localStorage.removeItem('adminToken');
            window.location.href = 'login.html';
        }
        
        // Export functions
        function exportUsers() {
            alert('Export users functionality will be implemented');
        }
        
        function exportOrders() {
            alert('Export orders functionality will be implemented');
        }
        
        // Mobile menu functions
        function toggleMobileMenu() {
            const sidebar = document.getElementById('adminSidebar');
            const overlay = document.querySelector('.mobile-menu-overlay');
            
            if (sidebar && overlay) {
                sidebar.classList.toggle('active');
                overlay.classList.toggle('active');
            }
        }
        
        function closeMobileMenu() {
            const sidebar = document.getElementById('adminSidebar');
            const overlay = document.querySelector('.mobile-menu-overlay');
            
            if (sidebar && overlay) {
                sidebar.classList.remove('active');
                overlay.classList.remove('active');
            }
        }
        
        // Inactivity timer
        function resetInactivityTimer() {
            if (inactivityTimer) {
                clearTimeout(inactivityTimer);
            }
            
            inactivityTimer = setTimeout(() => {
                if (confirm('You have been inactive for 60 minutes. Do you want to stay logged in?')) {
                    resetInactivityTimer();
                } else {
                    logout();
                }
            }, 60 * 60 * 1000); // 60 minutes
        }
        
        // Start inactivity timer
        function startInactivityTimer() {
            if (adminPanelLoaded) {
                resetInactivityTimer();
            }
        }
        
        // Add event listeners for inactivity
        document.addEventListener('mousemove', () => {
            if (adminPanelLoaded) resetInactivityTimer();
        });
        document.addEventListener('keypress', () => {
            if (adminPanelLoaded) resetInactivityTimer();
        });
    </script>
    
    <style>
        /* Additional styles for new elements */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            text-align: center;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .pagination {
            margin: 1rem 0;
        }
        
        .page-item.active .page-link {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            border-color: #3b82f6;
        }
    </style>
</body>
</html>