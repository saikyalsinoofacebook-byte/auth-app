<!DOCTYPE html>
<html lang="my">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Withdraw</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>

<style>
  body { background: #0f0931; color:#f1f5f9; font-family:sans-serif; }
  .card { background:#1c2255; border-radius:12px; border:none; }
  .method-btn { 
    border:2px solid #334155; border-radius:10px; 
    padding:10px; background:#0f172a; 
    color:#f1f5f9; font-weight:500;
  }
  .method-btn.active { 
    border-color:#22c55e; background:#0f172a; 
    box-shadow:0 0 8px rgba(34,197,94,0.6);
  }
  .form-label { 
    margin-top:10px; font-weight:600; 
    color:#e2e8f0;
  }
  .form-control {
    background:#0f172a; color:#f8fafc; 
    border:1px solid #475569;
  }
  .form-control::placeholder { color:#94a3b8; }
  small { color:#94a3b8; }
  .btn-submit { 
    background:linear-gradient(90deg,#f59e0b,#f97316); 
    border:none; color:white; 
    font-weight:600; padding:10px;
    border-radius:8px;
  }
  .btn-submit:disabled { opacity:0.6; }
  .btn-back { 
    background:#334155; border:none; 
    color:#fff; font-weight:500; 
    padding:10px; border-radius:8px;
  }
</style>

</head>
<body>

<div class="container py-4">
  <h3 class="text-center mb-4">ငွေထုတ် (Withdraw)</h3>

  <form id="withdraw-form" class="card p-3 shadow">
    <!-- Payment Method -->
    <label class="form-label">Select Payment Method</label>
    <div class="d-flex gap-2 mb-3">
      <button type="button" id="btn-kbz" class="flex-fill method-btn">
        <img src="images/kpaylogo.jpg" height="30" class="me-1"> KBZ Pay
      </button>
      <button type="button" id="btn-wave" class="flex-fill method-btn">
        <img src="images/wavepaylog.jpg" height="30" class="me-1"> Wave Pay
      </button>
    </div>
    <input type="hidden" id="method" required>

    <!-- Phone -->
    <label class="form-label"><i class="bi bi-telephone-fill"></i> Your Phone Number</label>
    <input type="text" id="phone" class="form-control" placeholder="09xxxxxxxxx" required>
    <small class="text-muted">Format: 09xxxxxxxxx (11 digits)</small>

    <!-- Recipient Name -->
    <label class="form-label mt-3"><i class="bi bi-person-fill"></i> Recipient Name</label>
    <input type="text" id="recipient" class="form-control" placeholder="Enter recipient name" required>

    <!-- Amount -->
    <label class="form-label mt-3"><i class="bi bi-cash-coin"></i> Amount (ကျပ်)</label>
    <input type="number" id="amount" class="form-control" placeholder="1000" min="1000" max="1000000" required>
    <small class="text-muted">Minimum: 1,000 | Maximum: 1,000,000</small>

    <!-- Buttons -->
    <div class="d-flex gap-2 mt-4">
      <button type="button" onclick="window.location.href='wallet.html'" class="btn btn-back flex-fill">
        <i class="bi bi-arrow-left"></i> နောက်သို့
      </button>
      <button id="submit-btn" type="submit" class="btn btn-submit flex-fill">
        ငွေထုတ်ရန် အတည်ပြုမည်
      </button>
    </div>
  </form>
</div>

<script>
  const API_BASE = window.location.hostname === "localhost"
    ? "http://localhost:5000"
    : window.location.origin;

  const USER = JSON.parse(localStorage.getItem("user"));
  const EMAIL = USER?.email || null;

  if (!EMAIL) {
    alert("ကျေးဇူးပြု၍ လော့ဂ်အင် ဝင်ပါ။");
    window.location.href = "login.html";
  }

  // Method select
  const methodInput = document.getElementById("method");
  const btnKBZ  = document.getElementById("btn-kbz");
  const btnWave = document.getElementById("btn-wave");

  function setMethod(method) {
    methodInput.value = method;
    [btnKBZ, btnWave].forEach(b => b.classList.remove("active"));
    (method === "KBZ Pay" ? btnKBZ : btnWave).classList.add("active");
  }
  btnKBZ.addEventListener("click", () => setMethod("KBZ Pay"));
  btnWave.addEventListener("click", () => setMethod("Wave Pay"));

  // Submit
  const form = document.getElementById("withdraw-form");
  const submitBtn = document.getElementById("submit-btn");

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const method = methodInput.value.trim();
    const phone = document.getElementById("phone").value.trim();
    const recipient = document.getElementById("recipient").value.trim();
    const amount = Number(document.getElementById("amount").value);

    if (!method) return alert("Payment Method ကို ရွေးပါ");
    if (!/^(09)\d{9}$/.test(phone)) return alert("Phone number 11 digits ထည့်ပါ");
    if (!recipient) return alert("Recipient name ထည့်ပါ");
    if (!amount || amount < 1000 || amount > 1000000) {
      return alert("Amount ကို 1,000 မှ 1,000,000 အတွင်းဖြည့်ပါ");
    }

    submitBtn.disabled = true;
    submitBtn.innerText = "Submitting...";

    try {
      const res = await fetch(`${API_BASE}/api/withdraw`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          email: EMAIL,
          phone: phone,
          recipient: recipient,
          amount: amount,
          method: method,
          status: "Pending"
        })
      });

      const data = await res.json();
      if (!res.ok) throw new Error(data?.error || "Withdraw failed");

      alert("Withdraw request submitted! (Pending)");
      window.location.href = "wallet.html";
    } catch (err) {
      console.error(err);
      alert("Withdraw error: " + err.message);
    } finally {
      submitBtn.disabled = false;
      submitBtn.innerText = "ငွေထုတ်ရန် အတည်ပြုမည်";
    }
  });
</script>

</body>
</html>
